from __future__ import annotations

from pathlib import Path

from excelbench.results.html_dashboard import render_html_dashboard


def test_render_html_dashboard_smoke(tmp_path: Path) -> None:
    fidelity = Path("results/xlsx/results.json")
    perf = Path("results/perf/results.json")
    scatter_dir = Path("results/xlsx")

    assert fidelity.exists(), "expected repo fixture results/xlsx/results.json to exist"
    assert perf.exists(), "expected repo fixture results/perf/results.json to exist"
    assert scatter_dir.exists(), "expected repo fixture results/xlsx to exist"

    out = tmp_path / "dashboard.html"
    render_html_dashboard(fidelity, perf, out, scatter_dir=scatter_dir)

    assert out.exists() and out.stat().st_size > 0
    html = out.read_text()
    assert "<title>ExcelBench Dashboard</title>" in html
    assert "<script>" in html


def test_render_html_dashboard_works_without_perf_or_svgs(tmp_path: Path) -> None:
    fidelity = tmp_path / "fidelity.json"
    fidelity.write_text(
        """
{
  "metadata": {"profile": "xlsx", "run_date": "2026-01-01T00:00:00Z"},
  "libraries": {
    "openpyxl": {"capabilities": ["read", "write"]},
    "pyumya": {"capabilities": ["read", "write"]}
  },
  "results": [
    {
      "feature": "cell_values",
      "library": "openpyxl",
      "scores": {"read": 3, "write": 3},
      "test_cases": {}
    },
    {
      "feature": "cell_values",
      "library": "pyumya",
      "scores": {"read": 3, "write": 3},
      "test_cases": {}
    }
  ]
}
""".strip()
    )

    out = tmp_path / "dashboard.html"
    render_html_dashboard(fidelity, perf_json=None, output_path=out, scatter_dir=None)

    assert out.exists() and out.stat().st_size > 0
    html = out.read_text()
    assert "<title>ExcelBench Dashboard</title>" in html
    assert "Generated by ExcelBench" in html
    assert "<th>Modify</th>" in html
    assert "Rewrite" in html
    assert "pyumya" not in html
